name: Build iOS App (Unsigned)

on:
   push:
     branches: [ main, develop ]
   pull_request:
     branches: [ main ]
   workflow_dispatch:

env:
   FLUTTER_VERSION: '3.16.0'

jobs:
   build-ios:
     runs-on: macos-latest

     steps:
     - name: Checkout repository
       uses: actions/checkout@v4

     - name: Setup Flutter
       uses: subosito/flutter-action@v2
       with:
         flutter-version: ${{ env.FLUTTER_VERSION }}
         channel: 'stable'

     - name: Install dependencies
       run: flutter pub get

     - name: Run tests
       run: flutter test

     - name: Analyze code
       run: flutter analyze

     - name: Build iOS app (Debug)
       run: |
         cd ios
         flutter build ios --debug --no-codesign

     - name: Build iOS app (Release)
       run: |
         cd ios
         flutter build ios --release --no-codesign

     - name: Archive iOS app
       run: |
         cd ios
         xcodebuild -workspace Runner.xcworkspace \
           -scheme Runner \
           -configuration Release \
           -destination generic/platform=iOS \
           -archivePath Runner.xcarchive \
           archive

     - name: Export IPA (Unsigned)
       run: |
         cd ios
         xcodebuild -exportArchive \
           -archivePath Runner.xcarchive \
           -exportPath ./build \
           -exportOptionsPlist ExportOptions.plist

     - name: Upload IPA artifact
       uses: actions/upload-artifact@v4
       with:
         name: ios-app-unsigned
         path: ios/build/*.ipa
         retention-days: 30



