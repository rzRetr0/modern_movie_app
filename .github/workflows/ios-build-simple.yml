name: Build Flutter iOS App (Unsigned, CocoaPods-free)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Setup Flutter
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.4'
          channel: 'stable'

      # 3️⃣ Install Flutter dependencies
      - name: Flutter pub get
        run: flutter pub get

      # 4️⃣ Precache iOS artifacts
      - name: Flutter precache iOS
        run: flutter precache --ios

      # 5️⃣ Clean old builds
      - name: Flutter clean
        run: flutter clean

      # 6️⃣ Build iOS app for simulator (no CocoaPods, no codesign)
      - name: Build iOS simulator app (unsigned)
        run: flutter build ios --simulator --no-codesign

      # 7️⃣ Create unsigned IPA from simulator build
      - name: Package unsigned IPA
        run: |
          APP_PATH="build/ios/iphonesimulator/Runner.app"
          if [ -d "$APP_PATH" ]; then
            echo "✅ Flutter simulator build successful"
            mkdir -p Payload
            cp -r "$APP_PATH" Payload/
            zip -r ios-app-unsigned.ipa Payload
            mkdir -p artifacts
            mv ios-app-unsigned.ipa artifacts/
            echo "✅ IPA created successfully"
          else
            echo "❌ Runner.app not found"
            find build -name "Runner.app" -print
            exit 1
          fi

      # 8️⃣ Upload IPA artifact
      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: ios-app-unsigned
          path: artifacts/*.ipa
          retention-days: 30
